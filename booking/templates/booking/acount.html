{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% trans "Ваш профіль" %}</title>
  <link rel="stylesheet" href="{% static 'main/css/acount.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://js.stripe.com/v3/"></script>
</head>
<body>
<div class="content">
  <h1>{% trans "Ваш профіль" %}</h1>
  <p class="p">{% trans "Вітаємо Вас" %} {{ user.username }}</p>

  <h2>{% trans "Ваші бронювання" %}</h2>
  {% if bookings %}
  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th><i class="bi bi-building"></i> {% trans "Готелі" %}</th>
        <th><i class="bi bi-door-closed"></i> {% trans "Тип номеру" %}</th>
        <th><i class="bi bi-cash-stack"></i> {% trans "Ціна за ніч" %}</th>
        <th><i class="bi bi-calendar-plus"></i> {% trans "Дата заїзду" %}</th>
        <th><i class="bi bi-calendar-minus"></i> {% trans "Дата виїзду" %}</th>
        <th><i class="bi bi-credit-card"></i> {% trans "Оплата" %}</th>
        <th><i class="bi bi-x-circle"></i> {% trans "Скасування" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for booking in bookings %}
      <tr>
        <td>{{ booking.room.hotel.name }}</td>
        <td>{{ booking.room.room_type.name }}</td>
        <td>{{ booking.room.price_per_night }} грн</td>
        <td>{{ booking.start_date }}</td>
        <td>{{ booking.end_date }}</td>
        <td>
          {% if not booking.is_paid %}
            <button class="btn btn-success" data-type="booking" data-id="{{ booking.id }}">
              <i class="bi bi-credit-card"></i> {% trans "Оплатити" %}
            </button>
          {% else %}
            <span style="color: green;"><i class="bi bi-check-circle-fill"></i> {% trans "Оплачено" %}</span>
          {% endif %}
        </td>
        <td>
          <form method="post" action="{% url 'cancel_booking' booking.id %}">
            {% csrf_token %}
            <button class="btn btn-danger" type="submit">
              <i class="bi bi-trash"></i> {% trans "Відмінити" %}
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>У вас немає замовлень готелів.</p>
  {% endif %}

  <div class="form mt-4">
    <a href="{% url 'home' %}" class="btn btn-primary"><i class="bi bi-house-door"></i> {% trans "На головну" %}</a>
  </div>
</div>

<footer class="footer mt-5 text-center text-white-50">
  <div class="footer-container">
    <p>&copy; 2025 Reservation-system.</p>
    <p>{% trans "Номер телефону" %}: +3800000000000</p>
    <p>{% trans "Пошта адміністрації" %}: <a href="mailto:reservation@gmail.com" class="text-decoration-none text-info">reservation@gmail.com</a></p>
  </div>
</footer>

<script>
    const stripe = Stripe ("{{ stripe_public_key }}");

  document.querySelectorAll(".pay-button").forEach(button => {
    button.addEventListener("click", function () {
      const id = this.dataset.id;
      const type = this.dataset.type;

      fetch("{% url 'create_checkout_session' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
          'id': id,
          'type': type
        }),
      })
      .then(res => res.json())
      .then(data => {
        if(data.sessionId) {
          stripe.redirectToCheckout({ sessionId: data.sessionId });
        } else {
          alert("Помилка оплати. Спробуйте пізніше.");
          console.error("No session ID in response");
        }
      })
      .catch(e => console.error(e));
    });
  });
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrfToken = getCookie("csrftoken");
</script>

</body>
</html>

